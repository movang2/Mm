<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrÃ¬nh Ä‘á»c vÄƒn báº£n cuá»™n tá»± Ä‘á»™ng kiá»ƒu AOD (CÃ³ ThÃ´ng BÃ¡o)</title>
  <style>
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      background: black; 
      color: white; 
      transition: 0.3s;
      min-height: 120vh;
      overflow-x: hidden;
    }
    
    /* Äá»“ng há»“ */
    #clock { font-size: 4em; margin-top: 20px; font-weight: bold; text-align: center; }
    #date { font-size: 1.2em; text-align: center; margin-bottom: 10px; }

    /* Controls */
    #controls { margin: 10px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; transition: 0.3s; }
    button, input[type="range"], input[type="number"], .setting-group { padding: 6px 12px; font-size: 1em; cursor: pointer; border-radius: 8px; border: none;}
    
    /* ThÃªm style cho nÃºt thÃ´ng bÃ¡o */
    #pushNotificationBtn { background: linear-gradient(135deg, #1565c0, #6a1b9a); color: white; font-weight: bold; }
    #pushNotificationBtn.active { background: linear-gradient(135deg, #2e7d32, #43a047); }
    .setting-group { background: #333; color: white; display: flex; align-items: center; gap: 5px; }
    input[type="number"] { background: #444; color: white; border: 1px solid #555; width: 50px; text-align: center;}


    /* Khung vÄƒn báº£n */
    #displayArea {
      max-height: 60vh;
      width: 90%;
      overflow-y: auto;
      padding: 1rem;
      background: #111;
      border: 1px solid #444;
      font-size: 1.2em;
      line-height: 1.6;
      white-space: pre-wrap;
      transition: height 0.3s, max-height 0.3s;
    }
    #scrollSlider { width: 90%; margin: 10px 0; accent-color: #0af; }

    /* Bong bÃ³ng */
    #bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #0af;
      color: white;
      padding: 12px;
      border-radius: 50%;
      font-size: 1.2em;
      cursor: move;
      display: none;
      user-select: none;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    /* ThÃ´ng tin Ä‘oáº¡n */
    #paragraphInfo {
      margin: 10px 0;
      font-size: 1em;
      color: #ccc;
    }

    /* Pháº§n padding thÃªm Ä‘á»ƒ kÃ©o xuá»‘ng */
    .scroll-padding {
      height: 100px;
      width: 100%;
      opacity: 0;
      pointer-events: none;
    }
    
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.95); padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; border: 1px solid #555; z-index: 10000; font-weight: bold; color: white;}
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="scroll-padding"></div>

  <div id="clock">00:00</div>
  <div id="date">-- -- ----</div>

  <h2>ğŸ“„ TrÃ¬nh Ä‘á»c vÄƒn báº£n cuá»™n tá»± Ä‘á»™ng</h2>
  <input type="file" id="fileInput" accept=".txt">

  <div id="controls">
    <button onclick="toggleScroll()">â–¶ï¸ Báº¯t Ä‘áº§u / â¸ï¸ Dá»«ng</button>
    <button onclick="toggleMode()" id="modeBtn">ğŸ“– Cháº¿ Ä‘á»™ tá»«ng Ä‘oáº¡n</button>
    <button onclick="clearProgress()" title="XÃ³a tiáº¿n trÃ¬nh Ä‘Ã£ lÆ°u">ğŸ§¹ XÃ³a tiáº¿n trÃ¬nh</button>
    <button id="pushNotificationBtn">ğŸ”” Báº­t thÃ´ng bÃ¡o</button> 
    
    <div class="setting-group">âŒš Cá»¡ ÄH: <input type="range" min="2" max="8" value="4" step="0.1" id="clockSize"></div>
    <div class="setting-group">ğŸ“ Cao khung: <input type="range" min="30" max="90" value="60" id="areaHeight"></div>
    <div class="setting-group">ğŸš€ Tá»‘c Ä‘á»™: <input type="range" min="1" max="10" value="3" id="speedRange"></div>
    
    <label id="paragraphTimeLabel" style="display: none;" class="setting-group">â±ï¸ Tg/Ä‘oáº¡n (s): <input type="number" min="1" max="60" value="3" id="paragraphTime"></label>
    
    <div class="setting-group">
        <label for="maxCharsPerDisplay">ğŸ”  Max Chá»¯ Hiá»ƒn Thá»‹:</label> 
        <input type="number" min="50" max="5000" value="500" id="maxCharsPerDisplay">
    </div>
    
    <div class="setting-group">ğŸ“ Max Chá»¯ thÃ´ng bÃ¡o: <input type="number" min="10" max="500" id="maxCharsPerNotif" value="100"></div> 
  </div>

  <div id="paragraphInfo"></div>

  <input type="range" min="0" max="100" value="0" id="scrollSlider">

  <div id="displayArea">ğŸ“‚ Vui lÃ²ng chá»n file TXT Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung...</div>

  <div id="bubble" onclick="restoreControls()">â¸ï¸</div>
  <div id="toast" class="toast"></div>

  <script>
    let scrolling = false;
    let interval;
    let paragraphMode = false;
    let paragraphs = [];
    let currentParagraphIndex = 0;
    let currentFileName = '';
    let fullTextContent = ''; 
    let pushEnabled = false; 
    
    const displayArea = document.getElementById("displayArea");
    const slider = document.getElementById("scrollSlider");
    const bubble = document.getElementById("bubble");
    const controls = document.getElementById("controls");
    const paragraphInfo = document.getElementById("paragraphInfo");
    const notifBtn = document.getElementById('pushNotificationBtn');
    const toastEl = document.getElementById('toast');


    const SESSION_ID = 'text_reader_' + Date.now();
    const DEFAULT_TEXT = 'ğŸ“‚ Vui lÃ²ng chá»n file TXT Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung...';


    window.addEventListener('load', function() {
      setTimeout(() => {
        window.scrollTo(0, 50);
        restoreProgress(); 
      }, 100);
    });

    // --- UTILITIES ---

    function showToast(msg) { 
        toastEl.textContent=msg; 
        toastEl.classList.add('show'); 
        setTimeout(()=>toastEl.classList.remove('show'),3000); 
    }

    /**
     * Cáº¯t vÄƒn báº£n thÃ´ng minh táº¡i dáº¥u cÃ¡ch gáº§n nháº¥t.
     * @param {string} text - VÄƒn báº£n gá»‘c.
     * @param {number} maxChars - Giá»›i háº¡n kÃ½ tá»± tá»‘i Ä‘a.
     * @param {boolean} addEllipsis - CÃ³ thÃªm '...' vÃ o cuá»‘i khÃ´ng.
     * @returns {string} - VÄƒn báº£n Ä‘Ã£ Ä‘Æ°á»£c cáº¯t.
     */
    function smartTruncate(text, maxChars, addEllipsis = false) {
        if (text.length <= maxChars) {
            return text;
        }
        let truncated = text.substring(0, maxChars);
        const lastSpace = truncated.lastIndexOf(' ');
        
        if (lastSpace !== -1) {
            const result = truncated.substring(0, lastSpace);
            return addEllipsis ? result + '...' : result;
        }
        // TrÆ°á»ng há»£p khÃ´ng cÃ³ dáº¥u cÃ¡ch trong pháº¡m vi maxChars, cáº¯t cá»©ng.
        return addEllipsis ? truncated + '...' : truncated; 
    }


    // --- LÆ¯U VÃ€ KHÃ”I PHá»¤C TRáº NG THÃI ---

    function saveProgress() {
      const progress = {
        sessionId: SESSION_ID,
        fileName: currentFileName,
        content: fullTextContent || displayArea.textContent, 
        paragraphMode: paragraphMode,
        currentParagraphIndex: currentParagraphIndex,
        scrollPosition: displayArea.scrollTop,
        scrollPercentage: slider.value,
        clockSize: document.getElementById("clockSize").value,
        areaHeight: document.getElementById("areaHeight").value,
        speed: document.getElementById("speedRange").value,
        paragraphTime: document.getElementById("paragraphTime").value, 
        maxCharsPerNotif: document.getElementById("maxCharsPerNotif").value, 
        maxCharsPerDisplay: document.getElementById("maxCharsPerDisplay").value, // LÆ¯U GIá»šI Háº N Má»šI
        isPushEnabled: pushEnabled, 
        timestamp: Date.now()
      };
      
      localStorage.setItem('textReaderProgress', JSON.stringify(progress));
    }

    function restoreProgress() {
      const saved = localStorage.getItem('textReaderProgress');
      if (!saved) return;

      const progress = JSON.parse(saved);
      if (progress.sessionId && progress.sessionId !== SESSION_ID) return;

      if (progress.content && progress.content !== DEFAULT_TEXT) {
        fullTextContent = progress.content; 
        currentFileName = progress.fileName || '';
        // TÃ¡ch Ä‘oáº¡n báº±ng .!? (chá»‰ filter Ä‘oáº¡n khÃ´ng rá»—ng)
        paragraphs = fullTextContent.split(/[.!?]+/).filter(p => p.trim().length > 0);
      } else {
        fullTextContent = '';
        paragraphs = [];
      }

      if (progress.paragraphMode !== undefined) {
        paragraphMode = progress.paragraphMode;
        document.getElementById("modeBtn").textContent = paragraphMode ? "ğŸ“œ Cháº¿ Ä‘á»™ cuá»™n liÃªn tá»¥c" : "ğŸ“– Cháº¿ Ä‘á»™ tá»«ng Ä‘oáº¡n";
        document.getElementById("paragraphTimeLabel").style.display = paragraphMode ? "flex" : "none";
        
        if (paragraphMode && paragraphs.length > 0 && progress.currentParagraphIndex !== undefined) {
          currentParagraphIndex = progress.currentParagraphIndex;
          showCurrentParagraph(false); // Gá»i showCurrentParagraph Ä‘á»ƒ Ã¡p dá»¥ng maxCharsPerDisplay
        } else if (!paragraphMode) {
            displayArea.textContent = fullTextContent;
            if (progress.scrollPosition !== undefined) {
              setTimeout(() => {
                displayArea.scrollTop = progress.scrollPosition;
                slider.value = progress.scrollPercentage || 0;
              }, 100);
            }
        }
      }

      // KhÃ´i phá»¥c cÃ i Ä‘áº·t
      if (progress.clockSize) document.getElementById("clockSize").value = progress.clockSize;
      if (progress.areaHeight) document.getElementById("areaHeight").value = progress.areaHeight;
      if (progress.speed) document.getElementById("speedRange").value = progress.speed;
      
      // KHÃ”I PHá»¤C INPUT NUMBER
      if (progress.paragraphTime) document.getElementById("paragraphTime").value = progress.paragraphTime;
      if (progress.maxCharsPerNotif) document.getElementById("maxCharsPerNotif").value = progress.maxCharsPerNotif; 
      if (progress.maxCharsPerDisplay) document.getElementById("maxCharsPerDisplay").value = progress.maxCharsPerDisplay; // KHÃ”I PHá»¤C GIá»šI Háº N Má»šI

      // KhÃ´i phá»¥c tráº¡ng thÃ¡i thÃ´ng bÃ¡o
      if (progress.isPushEnabled) {
          pushEnabled = true;
          notifBtn.innerHTML = "ğŸ”” ÄÃ£ báº­t"; 
          notifBtn.classList.add('active');
      }

      // Ãp dá»¥ng cÃ i Ä‘áº·t
      document.getElementById("clock").style.fontSize = document.getElementById("clockSize").value + "em";
      displayArea.style.maxHeight = document.getElementById("areaHeight").value + "vh";

      updateParagraphInfo();
      updateSliderForParagraphs();
    }

    function clearProgress() {
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a tiáº¿n trÃ¬nh Ä‘Ã£ lÆ°u?')) {
        localStorage.removeItem('textReaderProgress');
        location.reload(); 
      }
    }

    setInterval(saveProgress, 5000);

    // Load file TXT
    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      currentFileName = file.name;
      const reader = new FileReader();
      reader.onload = function(ev) {
        const content = ev.target.result;
        fullTextContent = content; 
        displayArea.textContent = content;
        // TÃ¡ch Ä‘oáº¡n báº±ng .!? (chá»‰ filter Ä‘oáº¡n khÃ´ng rá»—ng)
        paragraphs = content.split(/[.!?]+/).filter(p => p.trim().length > 0);
        currentParagraphIndex = 0;
        
        // Ãp dá»¥ng giá»›i háº¡n náº¿u Ä‘ang á»Ÿ cháº¿ Ä‘á»™ Ä‘oáº¡n
        if (paragraphMode) {
            showCurrentParagraph(false);
        }
        
        updateParagraphInfo();
        updateSliderForParagraphs();
        saveProgress(); 
        showToast(`ÄÃ£ táº£i file "${file.name}"`);
      };
      reader.readAsText(file);
    });

    // --- LOGIC CHUYá»‚N ÄOáº N/CUá»˜N ---
    
    function updateParagraphInfo() {
        if (paragraphMode && paragraphs.length > 0) {
            paragraphInfo.style.display = 'block';
            paragraphInfo.textContent = `Äoáº¡n ${currentParagraphIndex + 1} / ${paragraphs.length}`;
        } else {
            paragraphInfo.style.display = 'none';
        }
    }

    function updateSliderForParagraphs() {
        if (paragraphMode && paragraphs.length > 1) {
            slider.min = 0;
            slider.max = paragraphs.length - 1;
            slider.value = currentParagraphIndex;
        } else if (!paragraphMode && fullTextContent) {
            slider.min = 0;
            slider.max = 100;
        }
    }


    function toggleMode() {
      if (fullTextContent.length === 0) {
        showToast('Vui lÃ²ng chá»n file TXT trÆ°á»›c khi chuyá»ƒn cháº¿ Ä‘á»™.');
        return;
      }

      paragraphMode = !paragraphMode;
      const modeBtn = document.getElementById("modeBtn");
      const paragraphTimeLabel = document.getElementById("paragraphTimeLabel");
      
      if (paragraphMode) {
        modeBtn.textContent = "ğŸ“œ Cháº¿ Ä‘á»™ cuá»™n liÃªn tá»¥c";
        paragraphTimeLabel.style.display = "flex";
        if (paragraphs.length > 0) {
          showCurrentParagraph(); // Hiá»ƒn thá»‹ Ä‘oáº¡n Ä‘áº§u tiÃªn (Ä‘Ã£ cáº¯t)
        }
      } else {
        modeBtn.textContent = "ğŸ“– Cháº¿ Ä‘á»™ tá»«ng Ä‘oáº¡n";
        paragraphTimeLabel.style.display = "none";
        displayArea.textContent = fullTextContent; // Hiá»ƒn thá»‹ toÃ n bá»™ vÄƒn báº£n
        displayArea.scrollTop = 0; 
      }
      updateParagraphInfo();
      updateSliderForParagraphs();
      saveProgress(); 
    }

    // HÃ€M QUAN TRá»ŒNG ÄÃƒ ÄÆ¯á»¢C CHá»ˆNH Sá»¬A
    function showCurrentParagraph(shouldSave = true) {
      if (paragraphs.length > 0 && currentParagraphIndex < paragraphs.length) {
        // Láº¥y Ä‘oáº¡n gá»‘c (cÃ³ thÃªm dáº¥u cháº¥m)
        const fullParagraph = paragraphs[currentParagraphIndex].trim() + '.';
        
        // Äá»ŒC GIÃ TRá»Š GIá»šI Háº N HIá»‚N THá»Š TRÃŠN WEB (Má»šI)
        const maxDisplayChars = parseInt(document.getElementById("maxCharsPerDisplay").value) || 500;

        // Cáº®T ÄOáº N VÄ‚N Báº¢N Äá»‚ HIá»‚N THá»Š TRÃŠN WEB (KHÃ”NG THÃŠM ...)
        const displayContent = smartTruncate(fullParagraph, maxDisplayChars, false);
        
        displayArea.textContent = displayContent; // Hiá»ƒn thá»‹ ná»™i dung Ä‘Ã£ Ä‘Æ°á»£c cáº¯t

        // Gá»­i thÃ´ng bÃ¡o (chá»‰ á»Ÿ cháº¿ Ä‘á»™ Ä‘oáº¡n)
        if (pushEnabled) {
            const maxCharsNotif = parseInt(document.getElementById("maxCharsPerNotif").value) || 100;
            // Cáº¯t Ä‘oáº¡n Ä‘á»ƒ gá»­i thÃ´ng bÃ¡o (CÃ“ THÃŠM ...)
            const notificationBody = smartTruncate(fullParagraph, maxCharsNotif, true); 
            const title = `Äá»c: Äoáº¡n ${currentParagraphIndex + 1}/${paragraphs.length}`;
            sendNotification(title, notificationBody);
        }

        updateParagraphInfo();
        updateSliderForParagraphs();
        if (shouldSave) saveProgress(); 
      }
    }

    function nextParagraph() {
      if (currentParagraphIndex < paragraphs.length - 1) {
        currentParagraphIndex++;
        showCurrentParagraph();
      }
    }
    
    function previousParagraph() {
      if (currentParagraphIndex > 0) {
        currentParagraphIndex--;
        showCurrentParagraph();
      }
    }


    function toggleScroll() {
      if (fullTextContent.length === 0) {
        showToast('Vui lÃ²ng chá»n file TXT trÆ°á»›c khi báº¯t Ä‘áº§u cuá»™n/Ä‘á»c tá»± Ä‘á»™ng.');
        return;
      }
      
      scrolling = !scrolling;
      const scrollBtn = document.querySelector("#controls button");

      if (scrolling) {
        scrollBtn.textContent = 'â¸ï¸ Dá»«ng';
        controls.style.display = "none";
        bubble.style.display = "block";
        document.querySelector("h2").style.display = "none";
        document.getElementById("fileInput").style.display = "none";
        paragraphInfo.style.display = "none";
        
        if (!paragraphMode && pushEnabled) {
             sendNotification('ğŸš€ Báº¯t Ä‘áº§u cuá»™n', 'MÃ n hÃ¬nh sáº½ cuá»™n liÃªn tá»¥c...');
        }

        if (paragraphMode) {
          // Láº¥y giÃ¡ trá»‹ tá»« input type="number"
          const paragraphTime = parseFloat(document.getElementById("paragraphTime").value) * 1000; 
          interval = setInterval(() => {
            nextParagraph();
          }, paragraphTime);
        } else {
          interval = setInterval(() => {
            if (displayArea.scrollTop >= (displayArea.scrollHeight - displayArea.clientHeight)) {
                restoreControls(); 
                return;
            }
            displayArea.scrollTop += parseInt(document.getElementById("speedRange").value);
            // Cáº­p nháº­t slider khi cuá»™n
            slider.value = (displayArea.scrollTop / (displayArea.scrollHeight - displayArea.clientHeight)) * 100;
            saveProgress(); 
          }, 100);
        }
      } else {
        scrollBtn.textContent = 'â–¶ï¸ Báº¯t Ä‘áº§u';
        clearInterval(interval);
        saveProgress(); 
      }
    }

    function restoreControls() {
      clearInterval(interval);
      scrolling = false;
      controls.style.display = "flex";
      bubble.style.display = "none";
      document.querySelector("h2").style.display = "block";
      document.getElementById("fileInput").style.display = "block";
      document.querySelector("#controls button").textContent = 'â–¶ï¸ Báº¯t Ä‘áº§u / â¸ï¸ Dá»«ng';
      updateParagraphInfo();
      saveProgress(); 
    }
    
    // --- LOGIC THÃ”NG BÃO PUSH ---

    function sendNotification(title, body) {
      if (!pushEnabled) return;
      // DÃ¹ng emoji lÃ m icon
      const icon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“„%3C/text%3E%3C/svg%3E";
      
      navigator.serviceWorker.ready.then(reg => {
          reg.showNotification(title, { 
              body: body, 
              icon: icon, 
              tag: 'text-reader-app', 
              renotify: true, 
              vibrate: [100, 50, 100],
              silent: false 
          });
      });
    }

    notifBtn.addEventListener('click', async () => {
      if (!('serviceWorker' in navigator) || !('Notification' in window)) return showToast("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ thÃ´ng bÃ¡o.");
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') return showToast('âŒ Cáº§n cáº¥p quyá»n thÃ´ng bÃ¡o');

      try {
        // Äáº£m báº£o báº¡n cÃ³ file sw.js trong cÃ¹ng thÆ° má»¥c
        await navigator.serviceWorker.register('sw.js'); 
        pushEnabled = true;
        notifBtn.innerHTML = "ğŸ”” ÄÃ£ báº­t (Sáºµn sÃ ng)"; 
        notifBtn.classList.add('active');
        showToast("âœ… ÄÃ£ báº­t thÃ´ng bÃ¡o!");
        sendNotification("ğŸ”” Sáºµn sÃ ng", "ThÃ´ng bÃ¡o sáº½ hiá»‡n khi chuyá»ƒn Ä‘oáº¡n!");
        saveProgress();
      } catch (err) {
        showToast("Lá»—i Ä‘Äƒng kÃ½ Service Worker. HÃ£y kiá»ƒm tra file sw.js!");
      }
    });

    // --- CÃC HÃ€M CÅ¨ Cá»¦A Báº N (Cáº­p nháº­t) ---
    
    // Slider (Thanh trÆ°á»£t)
    slider.addEventListener("input", () => {
      if (paragraphMode && paragraphs.length > 1) {
        // Cháº¿ Ä‘á»™ Ä‘oáº¡n: Slider chuyá»ƒn Ä‘oáº¡n
        const paragraphIndex = parseInt(slider.value); // GiÃ¡ trá»‹ slider lÃ  index
        currentParagraphIndex = paragraphIndex;
        showCurrentParagraph();
      } else if (fullTextContent.length > 0) {
        // Cháº¿ Ä‘á»™ cuá»™n: Slider chuyá»ƒn vá»‹ trÃ­ cuá»™n
        displayArea.scrollTop = (slider.value / 100) * (displayArea.scrollHeight - displayArea.clientHeight);
        saveProgress(); 
      }
    });

    // CÃ i Ä‘áº·t chung
    document.getElementById("clockSize").addEventListener("input", function() {
      document.getElementById("clock").style.fontSize = this.value + "em";
      saveProgress();
    });

    document.getElementById("areaHeight").addEventListener("input", function() {
      displayArea.style.maxHeight = this.value + "vh";
      saveProgress();
    });

    // CÃ i Ä‘áº·t sá»‘
    document.getElementById("speedRange").addEventListener("input", saveProgress);
    document.getElementById("paragraphTime").addEventListener("input", saveProgress); 
    document.getElementById("maxCharsPerNotif").addEventListener("input", saveProgress);
    document.getElementById("maxCharsPerDisplay").addEventListener("input", saveProgress); // Láº¯ng nghe sá»± kiá»‡n input má»›i

    // Äá»“ng há»“
    function updateClock() {
      const now = new Date();
      let h = String(now.getHours()).padStart(2,"0");
      let m = String(now.getMinutes()).padStart(2,"0");
      document.getElementById("clock").textContent = `${h}:${m}`;
      const options = { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' };
      document.getElementById("date").textContent = now.toLocaleDateString("vi-VN", options);
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Logic di chuyá»ƒn bong bÃ³ng (Drag)
    bubble.addEventListener("mousedown", function(e) {
      let shiftX = e.clientX - bubble.getBoundingClientRect().left;
      let shiftY = e.clientY - bubble.getBoundingClientRect().top;
      function moveAt(pageX, pageY) {
        bubble.style.left = pageX - shiftX + 'px';
        bubble.style.top = pageY - shiftY + 'px';
      }
      function onMouseMove(e) { moveAt(e.pageX, e.pageY); }
      document.addEventListener('mousemove', onMouseMove);
      bubble.onmouseup = function() {
        document.removeEventListener('mousemove', onMouseMove);
        bubble.onmouseup = null;
      };
    });
    bubble.ondragstart = () => false;

    // PhÃ­m táº¯t
    document.addEventListener('keydown', function(e) {
      if (fullTextContent.length > 0 && !scrolling) {
          if (paragraphMode) {
              if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextParagraph();
              } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousParagraph();
              }
          } else if (e.key === ' ') { 
              e.preventDefault();
              toggleScroll();
          }
      }
    });

    window.addEventListener('beforeunload', saveProgress);
  </script>
</body>
</html>
